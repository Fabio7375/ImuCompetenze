<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calcolatore Competenze IMU – BDZ Associati</title>
  <style>
    /* RESET & FONT */
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #faf8f7;
      color: #333;
      line-height: 1.4;
      padding: 20px;
    }
    h1 { text-align:center; margin-bottom:20px; color:#6b4c57; }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .card {
      background: #fff;
      border: 1px solid #e1e5e9;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .card h2 {
      font-size: 18px;
      margin-bottom: 10px;
      color: #6b4c57;
    }
    label { display:block; margin-bottom:5px; font-size:14px; color:#8b6b73; }
    input[type="text"],
    input[type="number"],
    select {
      width:100%;
      padding:10px;
      margin-bottom:15px;
      border:1px solid #d1d5db;
      border-radius:8px;
      font-size:14px;
    }
    pre {
      background:#f8f9fa;
      padding:15px;
      border-radius:8px;
      font-family:Consolas, "Courier New", monospace;
      font-size:13px;
      white-space: pre-wrap;
      border:1px solid #e9ecef;
      margin-bottom:15px;
    }
    .result {
      text-align:center;
      padding:20px;
      background: linear-gradient(135deg,#f7f3f3 0%,#ede5e1 100%);
      border-radius:12px;
      border:1px solid #e0d4d0;
    }
    .result h3 {
      margin-bottom:10px;
      color:#6b4c57;
    }
    .result .amount {
      font-size:32px;
      font-weight:bold;
      margin-bottom:5px;
    }
    button {
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      margin: 0 auto;
      padding:12px 20px;
      font-size:16px;
      border:none;
      border-radius:10px;
      background: #6b4c57;
      color:#fff;
      cursor:pointer;
      transition:background .2s;
    }
    button:hover { background: #563d46; }
  </style>
</head>
<body>

  <h1>Calcolatore Competenze IMU 2025</h1>
  <div class="container">
    <!-- INGRESSO DATI -->
    <div class="card">
      <h2>Dati Cliente</h2>
      <label>Cliente:</label>
      <input type="text" id="cliente" placeholder="Inserisci nome cliente" />

      <label>Tipo Calcolo:</label>
      <select id="tipoCalcolo">
        <option value="acconto">Acconto (50%)</option>
        <option value="saldo">Saldo (100%)</option>
      </select>

      <label>Voce Contabile:</label>
      <input type="text" id="voceContabile" value="00010" />

      <h2>Prezzi personalizzabili</h2>
      <label>Prezzo Immobili non <strong>C2/C6/C7</strong> (€):</label>
      <input type="number" id="priceNonC2" min="0" step="0.01" value="28.00" />

      <label>Prezzo Immobili <strong>C2/C6/C7 e terreni</strong> (€):</label>
      <input type="number" id="priceC2" min="0" step="0.01" value="17.00" />

      <label>Prezzo Dal 3° immobile (€):</label>
      <input type="number" id="priceDal3" min="0" step="0.01" value="17.00" />

      <h2>Numero Immobili per Categoria</h2>
      <label>Immobili non <strong>C2/C6/C7</strong> (A2, A3…):</label>
      <input type="number" id="immNonC2" min="0" value="0" />

      <label><strong>Immobili C2/C6/C7 e terreni</strong> (A1…):</label>
      <input type="number" id="immC2" min="0" value="0" />

      <label>Dal 3° immobile:</label>
      <input type="number" id="immDal3" min="0" value="0" />

      <h2>Configurazione Sconti (%)</h2>
      <label>Soglia C2/C6/C7 e terreni:</label>
      <input type="number" id="sogC2" min="1" value="100" />
      <label>Sconto % C2/C6/C7:</label>
      <input type="number" id="scoC2" min="0" max="100" value="0" />

      <label>Soglia non C2/C6/C7:</label>
      <input type="number" id="sogNonC2" min="1" value="100" />
      <label>Sconto % non C2/C6/C7:</label>
      <input type="number" id="scoNonC2" min="0" max="100" value="0" />

      <label>Soglia Dal 3° immobile:</label>
      <input type="number" id="sogDal3" min="1" value="100" />
      <label>Sconto % Dal 3°:</label>
      <input type="number" id="scoDal3" min="0" max="100" value="0" />

      <label>Soglia complessiva:</label>
      <input type="number" id="sogComp" min="1" value="100" />
      <label>Sconto % complessivo:</label>
      <input type="number" id="scoComp" min="0" max="100" value="0" />
    </div>

    <!-- RISULTATI -->
    <div class="card">
      <h2>Dettaglio Calcolo</h2>
      <pre id="dettaglio">Inserisci i dati per vedere il calcolo…</pre>

      <div class="result">
        <h3 id="titoloRisultato">Competenze Acconto IMU</h3>
        <div class="amount" id="importo">€0.00</div>
        <div>Voce contabile: <span id="vc">00010</span></div>
      </div>

      <button id="btnScarica">Scarica Report</button>
    </div>
  </div>

  <script>
    const f = {
      cliente:        document.getElementById('cliente'),
      tipoCalcolo:    document.getElementById('tipoCalcolo'),
      voceContabile:  document.getElementById('voceContabile'),
      priceC2:        document.getElementById('priceC2'),
      priceNonC2:     document.getElementById('priceNonC2'),
      priceDal3:      document.getElementById('priceDal3'),
      immC2:          document.getElementById('immC2'),
      immNonC2:       document.getElementById('immNonC2'),
      immDal3:        document.getElementById('immDal3'),
      sogC2:          document.getElementById('sogC2'),
      scoC2:          document.getElementById('scoC2'),
      sogNonC2:       document.getElementById('sogNonC2'),
      scoNonC2:       document.getElementById('scoNonC2'),
      sogDal3:        document.getElementById('sogDal3'),
      scoDal3:        document.getElementById('scoDal3'),
      sogComp:        document.getElementById('sogComp'),
      scoComp:        document.getElementById('scoComp'),
      dettaglio:      document.getElementById('dettaglio'),
      importo:        document.getElementById('importo'),
      titoloRis:      document.getElementById('titoloRisultato'),
      vc:             document.getElementById('vc'),
      btn:            document.getElementById('btnScarica'),
    };

    const minimoGarantito = 23.00;

    function calcola() {
      // leggo prezzi dinamici
      const prezzi = {
        c2:     parseFloat(f.priceC2.value)    || 0,
        nonC2:  parseFloat(f.priceNonC2.value) || 0,
        dal3:   parseFloat(f.priceDal3.value)  || 0
      };

      const nNon   = +f.immNonC2.value || 0;
      const nC2    = +f.immC2.value    || 0;
      const nDal3  = +f.immDal3.value  || 0;
      const sogN2  = +f.sogNonC2.value || 100;
      const scoN2  = +f.scoNonC2.value || 0;
      const sogC2  = +f.sogC2.value    || 100;
      const scoC2  = +f.scoC2.value    || 0;
      const sogD3  = +f.sogDal3.value  || 100;
      const scoD3  = +f.scoDal3.value  || 0;
      const sogC   = +f.sogComp.value  || 100;
      const scoC   = +f.scoComp.value  || 0;

      let dettaglioTxt = '', totale=0;

      function elabora(count, prezzo, soglia, sconto, label) {
        if (count<=0) return 0;
        const fullCount = Math.min(count, soglia);
        const overCount = Math.max(0, count - soglia);
        const costFull  = fullCount * prezzo;
        const costOver  = overCount * prezzo;
        let discount    = overCount>0 ? costOver * (sconto/100) : 0;
        let subtotal    = costFull + (costOver - discount);

        dettaglioTxt += `${label}: ${count}×€${prezzo.toFixed(2)} = €${(count*prezzo).toFixed(2)}\n`;
        dettaglioTxt += `  Soglia (${soglia}): ${fullCount}×€${prezzo.toFixed(2)} = €${costFull.toFixed(2)}\n`;
        if (overCount>0) {
          dettaglioTxt += `  Eccedenza: ${overCount}×€${prezzo.toFixed(2)} = €${costOver.toFixed(2)}\n`;
          dettaglioTxt += `  Sconto ${sconto}% su eccedenza: -€${discount.toFixed(2)}\n`;
        }
        dettaglioTxt += `  Subtotale: €${subtotal.toFixed(2)}\n\n`;
        return subtotal;
      }

      totale += elabora(nNon, prezzi.nonC2, sogN2, scoN2, 'Non C2/C6/C7');
      totale += elabora(nC2,  prezzi.c2,    sogC2, scoC2, 'C2/C6/C7 e terreni');
      totale += elabora(nDal3,prezzi.dal3,  sogD3, scoD3, 'Dal 3° immobile');

      // sconto complessivo
      const totImm = nNon + nC2 + nDal3;
      if (totImm >= sogC && scoC>0) {
        let discount = totale * (scoC/100);
        totale -= discount;
        dettaglioTxt += `Sconto complessivo ${scoC}%: -€${discount.toFixed(2)}\n\n`;
      }

      dettaglioTxt += `Totale imponibile: €${totale.toFixed(2)}\n`;
      let importo = f.tipoCalcolo.value==='acconto' ? totale/2 : totale;
      dettaglioTxt += f.tipoCalcolo.value==='acconto'
        ? `Acconto (50%): €${importo.toFixed(2)}\n`
        : `Importo pieno: €${importo.toFixed(2)}\n`;

      if (importo < minimoGarantito) {
        dettaglioTxt += `Minimo garantito: €${minimoGarantito.toFixed(2)}\n`;
        importo = minimoGarantito;
      }

      f.dettaglio.textContent   = dettaglioTxt;
      f.importo.textContent     = `€${importo.toFixed(2)}`;
      f.titoloRis.textContent   = `Competenze ${f.tipoCalcolo.value.charAt(0).toUpperCase()+f.tipoCalcolo.value.slice(1)} IMU`;
      f.vc.textContent          = f.voceContabile.value;
    }

    // Download report
    f.btn.addEventListener('click', ()=>{
      const testo =
`STUDIO BDZ ASSOCIATI
Calcolo Competenze IMU 2025

Cliente: ${f.cliente.value||'–'}
Tipo: ${f.tipoCalcolo.value.charAt(0).toUpperCase()+f.tipoCalcolo.value.slice(1)}
Voce: ${f.voceContabile.value}

--- DETTAGLIO ---
${f.dettaglio.textContent}

Totale: ${f.importo.textContent}
`;
      const blob = new Blob([testo],{type:'text/plain'});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = `competenze_IMU_${f.cliente.value||'cliente'}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    // Event listeners
    ['priceC2','priceNonC2','priceDal3',
     'immNonC2','immC2','immDal3',
     'sogNonC2','scoNonC2','sogC2','scoC2','sogDal3','scoDal3','sogComp','scoComp',
     'tipoCalcolo','voceContabile']
      .forEach(id => document.getElementById(id).addEventListener('input', calcola));

    calcola();  // calcolo iniziale
  </script>

</body>
</html>
