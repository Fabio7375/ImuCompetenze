<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calcolatore Competenze IMU – BDZ Associati</title>
  <style>
    /* Stili CSS invariati... */
    * { box-sizing:border-box; margin:0; padding:0 }
    body {
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background:#faf8f7; color:#333; line-height:1.4;
      padding:20px;
    }
    h1 { text-align:center; margin-bottom:20px; color:#6b4c57 }
    .container {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:20px;
      width:100%;
      max-width:100vw;
    }
    .card {
      background:#fff; border:1px solid #e1e5e9;
      border-radius:12px; padding:20px;
      box-shadow:0 4px 10px rgba(0,0,0,0.05);
    }
    .card h2 {
      font-size:18px; margin-bottom:10px; color:#6b4c57;
    }
    label {
      display:block; margin-bottom:5px;
      font-size:14px; color:#8b6b73;
    }
    input[type="text"], input[type="number"], select {
      width:100%; padding:8px;
      border:1px solid #d1d5db; border-radius:6px;
      font-size:14px; margin-bottom:12px;
    }
    .form-grid {
      display:grid;
      grid-template-columns: repeat(2, minmax(200px, 1fr));
      column-gap:20px; row-gap:12px;
    }
    .card.sconti {
      border:2px dashed #8b6b73;
      background: #f9f5f5;
    }
    pre {
      background:#f8f9fa; padding:15px;
      border-radius:8px; font-family:Consolas,monospace;
      font-size:13px; white-space:pre-wrap;
      border:1px solid #e9ecef; margin-bottom:15px;
    }
    .result {
      text-align:center; padding:20px;
      background:linear-gradient(135deg,#f7f3f3,#ede5e1);
      border-radius:12px; border:1px solid #e0d4d0;
    }
    .result h3 { margin-bottom:10px; color:#6b4c57 }
    .result .amount {
      font-size:32px; font-weight:bold; margin-bottom:5px;
    }
    button {
      display:inline-block; padding:10px 20px;
      font-size:15px; border:none; border-radius:8px;
      background:#6b4c57; color:#fff; cursor:pointer;
      transition:background .2s; margin-top:10px;
    }
    button:hover { background:#563d46 }
  </style>
</head>
<body>

  <h1>Calcolatore Competenze IMU 2025</h1>
  <div class="container">

    <!-- SINISTRA: INPUT -->
    <div class="card">
      <h2>Dati Cliente & Prezzi Base</h2>
      <div class="form-grid">
        <div>
          <label>Cliente</label>
          <input type="text" id="cliente" placeholder="Nome cliente"/>
        </div>
        <div>
          <label>Tipo Calcolo</label>
          <select id="tipoCalcolo">
            <option value="acconto">1° o 2° acconto semestrale (50%)</option>
            <option value="saldo">Saldo (Totale annuo 100%)</option>
          </select>
        </div>
        <div>
          <label>Voce Contabile</label>
          <input type="text" id="voceContabile" value="00010"/>
        </div>
         <!-- MODIFICA: Spostati i prezzi base qui -->
        <div>
          <label id="labelPriceNonC2">Prezzo Base ABITATIVI (€)</label>
          <input type="number" id="priceNonC2" step="0.01" value="28.00"/>
        </div>
        <div>
          <label id="labelPriceC2">Prezzo Base C2/C6/C7 (€)</label>
          <input type="number" id="priceC2" step="0.01" value="17.00"/>
        </div>
        <div>
          <label id="labelPriceCat3">Prezzo Base Categoria Pers. (€)</label>
          <input type="number" id="priceDal3" step="0.01" value="17.00"/>
        </div>
      </div>

      <h2>Numero Immobili e Categoria Personalizzata</h2>
       <!-- MODIFICA: Aggiunto campo per nome categoria personalizzata -->
      <div class="form-grid" style="grid-template-columns: 1fr;">
         <div>
            <label for="nomeCat3">Nome Categoria Personalizzata (es. Terreni, Cat. D, ecc.)</label>
            <input type="text" id="nomeCat3" placeholder="Es: Terreni edificabili">
        </div>
      </div>
      <div class="form-grid">
        <div>
          <!-- MODIFICA: Etichetta cambiata -->
          <label id="labelImmNonC2">N° ABITATIVI (non C2 C6)</label>
          <input type="number" id="immNonC2" min="0" value="0"/>
        </div>
        <div>
          <label id="labelImmC2">N° C2/C6/C7 e terreni</label>
          <input type="number" id="immC2" min="0" value="0"/>
        </div>
        <div>
           <!-- MODIFICA: Etichetta dinamica -->
          <label id="labelImmCat3">N° Categoria Personalizzata</label>
          <input type="number" id="immDal3" min="0" value="0"/>
        </div>
      </div>

      <!-- MODIFICA: Riquadro soglie e prezzi eccedenze -->
      <div class="card sconti">
        <h2>Configurazione Soglie e Prezzi Eccedenze</h2>
        <div class="form-grid">
          <div>
            <label id="labelSogNonC2">Soglia ABITATIVI</label>
            <input type="number" id="sogNonC2" min="0" value="100"/>
          </div>
          <div>
            <!-- MODIFICA: Da sconto a prezzo eccedenza -->
            <label id="labelPriceOverNonC2">Prezzo Eccedenze ABITATIVI (€)</label>
            <input type="number" id="priceOverNonC2" step="0.01" value="10.00"/>
          </div>
          <div>
            <label id="labelSogC2">Soglia C2/C6/C7</label>
            <input type="number" id="sogC2" min="0" value="100"/>
          </div>
          <div>
             <!-- MODIFICA: Da sconto a prezzo eccedenza -->
            <label id="labelPriceOverC2">Prezzo Eccedenze C2/C6/C7 (€)</label>
            <input type="number" id="priceOverC2" step="0.01" value="8.00"/>
          </div>
          <div>
             <!-- MODIFICA: Etichetta dinamica -->
            <label id="labelSogCat3">Soglia Categoria Personalizzata</label>
            <input type="number" id="sogDal3" min="0" value="100"/>
          </div>
          <div>
            <!-- MODIFICA: Da sconto a prezzo eccedenza -->
            <label id="labelPriceOverCat3">Prezzo Eccedenze Categoria Pers. (€)</label>
            <input type="number" id="priceOverDal3" step="0.01" value="8.00"/>
          </div>
          <div>
            <label>Soglia Complessiva Immobili</label>
            <input type="number" id="sogComp" min="1" value="100"/>
          </div>
          <div>
            <label>Sconto % su Totale Complessivo</label>
            <input type="number" id="scoComp" min="0" max="100" value="0"/>
          </div>
        </div>
      </div>
    </div>

    <!-- DESTRA: RISULTATI (invariato) -->
    <div class="card" style="overflow-y:auto; max-height:calc(100vh - 60px);">
      <h2>Dettaglio Calcolo</h2>
      <pre id="dettaglio">Inserisci i dati per vedere il calcolo…</pre>

      <div class="result">
        <h3 id="titoloRisultato">Competenze Acconto IMU</h3>
        <div class="amount" id="importo">€0.00</div>
        <div>Voce contabile: <span id="vc">00010</span></div>
      </div>

      <button id="btnScarica">Scarica Report Word (.doc)</button>
    </div>
  </div>

  <script>
    // MODIFICA: Aggiornato l'elenco degli ID degli elementi
    const f = {};
    const ids = [
        'cliente', 'tipoCalcolo', 'voceContabile',
        'priceNonC2', 'priceC2', 'priceDal3',
        'immNonC2', 'immC2', 'immDal3',
        'nomeCat3', // Aggiunto
        'sogNonC2', 'priceOverNonC2', // Modificato
        'sogC2', 'priceOverC2',       // Modificato
        'sogDal3', 'priceOverDal3',   // Modificato
        'sogComp', 'scoComp',
        'dettaglio', 'importo', 'titoloRisultato', 'vc', 'btnScarica',
        // ID delle etichette per aggiornamento dinamico
        'labelImmNonC2', 'labelPriceNonC2', 'labelSogNonC2', 'labelPriceOverNonC2',
        'labelImmC2', 'labelPriceC2', 'labelSogC2', 'labelPriceOverC2',
        'labelImmCat3', 'labelPriceCat3', 'labelSogCat3', 'labelPriceOverCat3'
    ];
    ids.forEach(id => f[id] = document.getElementById(id));

    const minimoGarantito = 23.00;

    // MODIFICA: Funzione per aggiornare le etichette della categoria personalizzata
    function aggiornaEtichette() {
        const nomeCat = f.nomeCat3.value.trim();
        const nomeDefault = "Categoria Personalizzata";
        const nomeFinale = nomeCat || nomeDefault;

        // Aggiorna tutte le etichette relative alla terza categoria
        f.labelImmCat3.textContent = `N° ${nomeFinale}`;
        f.labelPriceCat3.textContent = `Prezzo Base ${nomeFinale} (€)`;
        f.labelSogCat3.textContent = `Soglia ${nomeFinale}`;
        f.labelPriceOverCat3.textContent = `Prezzo Eccedenze ${nomeFinale} (€)`;
        
        calcola(); // Ricalcola tutto ogni volta che il nome cambia
    }


    function calcola() {
      // prezzi base e prezzi eccedenze
      const prezziBase = {
        nonC2: parseFloat(f.priceNonC2.value) || 0,
        c2:    parseFloat(f.priceC2.value)    || 0,
        dal3:  parseFloat(f.priceDal3.value)  || 0
      };
      const prezziOver = {
        nonC2: parseFloat(f.priceOverNonC2.value) || 0,
        c2:    parseFloat(f.priceOverC2.value)    || 0,
        dal3:  parseFloat(f.priceOverDal3.value)  || 0
      };

      const n = (id => +f[id].value || 0);
      const n0 = n('immNonC2'), n1 = n('immC2'), n2 = n('immDal3');
      const s = (id => +f[id].value || 0);
      let dettaglioTxt = '', totale = 0;

      // MODIFICA: Logica di calcolo aggiornata
      function calc(count, prezzoBase, soglia, prezzoEccedenza, label) {
        if (count <= 0) return 0;
        
        const inSoglia = Math.min(count, soglia);
        const eccedenza = Math.max(0, count - soglia);

        const costoInSoglia = inSoglia * prezzoBase;
        const costoEccedenza = eccedenza * prezzoEccedenza;
        
        const subTotale = costoInSoglia + costoEccedenza;
        
        dettaglioTxt += `${label}: ${count} immobili\n`;
        dettaglioTxt += `  Entro soglia (${inSoglia}): ${inSoglia} × €${prezzoBase.toFixed(2)} = €${costoInSoglia.toFixed(2)}\n`;
        if (eccedenza > 0) {
          dettaglioTxt += `  Eccedenza (${eccedenza}): ${eccedenza} × €${prezzoEccedenza.toFixed(2)} = €${costoEccedenza.toFixed(2)}\n`;
        }
        dettaglioTxt += `  Subtotale: €${subTotale.toFixed(2)}\n\n`;
        return subTotale;
      }
      
      const nomeCat3 = f.nomeCat3.value.trim() || "Categoria Personalizzata";

      totale += calc(n0, prezziBase.nonC2, s('sogNonC2'), prezziOver.nonC2, 'ABITATIVI (non C2 C6)');
      totale += calc(n1, prezziBase.c2,    s('sogC2'),    prezziOver.c2,    'C2/C6/C7 e terreni');
      totale += calc(n2, prezziBase.dal3,  s('sogDal3'),  prezziOver.dal3,  nomeCat3);

      // Sconto complessivo (logica invariata)
      const totI = n0 + n1 + n2, scC = s('scoComp');
      if (totI >= s('sogComp') && scC > 0) {
        const d = totale * (scC / 100);
        totale -= d;
        dettaglioTxt += `Sconto complessivo ${scC}% su €${(totale+d).toFixed(2)}: -€${d.toFixed(2)}\n\n`;
      }

      dettaglioTxt += `Totale imponibile: €${totale.toFixed(2)}\n`;
      let imp = f.tipoCalcolo.value === 'acconto' ? totale / 2 : totale;
      dettaglioTxt += f.tipoCalcolo.value === 'acconto'
        ? `Acconto (50%): €${imp.toFixed(2)}\n`
        : `Importo pieno: €${imp.toFixed(2)}\n`;
      if (imp < minimoGarantito && imp > 0) {
        dettaglioTxt += `Applicato minimo garantito: €${minimoGarantito.toFixed(2)}\n`;
        imp = minimoGarantito;
      }

      f.dettaglio.textContent = dettaglioTxt;
      f.importo.textContent = `€${imp.toFixed(2)}`;
      
      const selectedOptionText = f.tipoCalcolo.options[f.tipoCalcolo.selectedIndex].text;
      f.titoloRisultato.textContent = `Competenze ${selectedOptionText}`;
      f.vc.textContent = f.voceContabile.value;
    }

    // listeners
    Object.values(f).forEach(el => {
      if (el && (el.tagName === 'INPUT' || el.tagName === 'SELECT')) {
          // L'evento per l'input del nome categoria è gestito a parte
          if (el.id !== 'nomeCat3') {
              el.addEventListener('input', calcola);
          }
      }
    });

    // MODIFICA: Listener specifico per il campo nome categoria
    f.nomeCat3.addEventListener('input', aggiornaEtichette);

    // Funzione download (invariata)
    document.getElementById('btnScarica').addEventListener('click',()=>{
      const selectedOptionText = f.tipoCalcolo.options[f.tipoCalcolo.selectedIndex].text;
      const clienteNome = f.cliente.value || 'N/D';

      const htmlContent = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>Report Competenze IMU</title></head>
        <body>
          <h1>STUDIO BDZ ASSOCIATI</h1>
          <h2>Report Calcolo Competenze IMU 2025</h2>
          <p><strong>Cliente:</strong> ${clienteNome}</p>
          <p><strong>Tipo Calcolo:</strong> ${selectedOptionText}</p>
          <p><strong>Voce Contabile:</strong> ${f.voceContabile.value}</p>
          <hr>
          <h3>DETTAGLIO CALCOLO</h3>
          <pre>${f.dettaglio.textContent}</pre>
          <hr>
          <h3>TOTALE FINALE: ${f.importo.textContent}</h3>
        </body>
        </html>`;

      const blob = new Blob(['\ufeff', htmlContent], {
        type: 'application/msword'
      });
      
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Report_IMU_${clienteNome.replace(/ /g, '_')}.doc`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    // calcolo iniziale e setup etichette
    aggiornaEtichette();

  </script>
</body>
</html>
